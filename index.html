<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Programme J√©r√©my ‚Äî Haut du corps + Abdos</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#111826; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#3b82f6; --danger:#ef4444; --warn:#f59e0b;
      --border:#1f2937;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(59,130,246,.18), transparent),
        radial-gradient(1000px 600px at 100% 0%, rgba(34,197,94,.18), transparent),
        var(--bg);
      color:var(--text);
    }
    header{ padding:22px 16px 10px; max-width:1100px; margin:0 auto; }
    .title{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .badge{
      font-size:12px; padding:6px 10px; border:1px solid var(--border); border-radius:999px;
      color:var(--muted); background: rgba(17,24,38,.6);
    }
    h1{ margin:0; font-size:22px; letter-spacing:.2px; }
    .sub{ margin:10px 0 0; color:var(--muted); line-height:1.45; font-size:14px; }

    .wrap{ max-width:1100px; margin:0 auto; padding:12px 16px 28px; }

    .toolbar{
      display:grid; gap:10px;
      background: rgba(17,24,38,.6); border:1px solid var(--border);
      padding:12px; border-radius:var(--radius); box-shadow: var(--shadow);
    }
    .toolbarRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .toolbarRow.space{ justify-content:space-between; }
    .group{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }

    button{
      border:1px solid var(--border);
      background: rgba(17,24,38,.85);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
    }
    button:hover{border-color: rgba(59,130,246,.6)}
    .btn-accent{ background: rgba(34,197,94,.15); border-color: rgba(34,197,94,.35); }
    .btn-danger{ background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.35); }
    .btn-warn{ background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.35); }
    .btn-blue{ background: rgba(59,130,246,.14); border-color: rgba(59,130,246,.35); }

    .select, .input{
      border:1px solid var(--border);
      background: rgba(17,24,38,.85);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:700;
      min-width: 170px;
    }
    .input{ min-width: 120px; }
    .hint{ color:var(--muted); font-size:12px; }
    .mono{ font-family: var(--mono); }

    .grid{
      display:grid; gap:12px; margin-top:12px;
      grid-template-columns: repeat(12, 1fr);
    }
    .card{
      grid-column: span 12;
      background: rgba(17,24,38,.6);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding:14px 14px 10px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;
      border-bottom:1px solid rgba(31,41,55,.7);
    }
    .card-h h2{ margin:0; font-size:16px; }
    .meta{ color:var(--muted); font-size:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill{
      padding:4px 8px; border-radius:999px; border:1px solid var(--border);
      background: rgba(11,15,20,.35); color:var(--muted);
    }
    .pill.good{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); color: #b7f7c8; }
    .pill.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); color: #ffe3a3; }
    .pill.bad{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); color: #ffb4b4; }

    .content{ padding:12px 14px 14px; }
    .ex{
      border:1px solid rgba(31,41,55,.7);
      border-radius:14px;
      padding:12px;
      background: rgba(11,15,20,.35);
      margin-top:10px;
    }
    .ex-top{
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
    }
    .ex-name{ font-weight:900; }
    .ex-desc{ color:var(--muted); font-size:12px; margin-top:6px; line-height:1.35; }
    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px;
    }
    .check{
      display:flex; gap:8px; align-items:center;
      padding:8px 10px; border-radius:12px; border:1px solid rgba(31,41,55,.7);
      background: rgba(17,24,38,.55);
    }
    input[type="checkbox"]{ width:18px; height:18px; accent-color: var(--accent); }
    .small{ font-size:12px; color:var(--muted); }

    .video{
      width:100%;
      aspect-ratio: 16/9;
      border:0;
      border-radius: 12px;
      margin-top:10px;
      background:#000;
    }

    .progress{
      height:10px; border-radius:999px; background: rgba(148,163,184,.15); overflow:hidden;
      border:1px solid rgba(31,41,55,.7);
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(34,197,94,.9), rgba(59,130,246,.9));
    }

    .panel{
      border:1px solid rgba(31,41,55,.7);
      border-radius:14px;
      background: rgba(11,15,20,.35);
      padding:12px;
    }

    .timerBox{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
    }
    .timerLeft{ display:flex; flex-wrap:wrap; gap:10px; align-items:end; }
    .timerDisplay{
      min-width: 160px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(31,41,55,.7);
      background: rgba(17,24,38,.55);
    }
    .timerBig{ font-size:20px; font-weight:900; letter-spacing: .5px; }
    .timerSmall{ font-size:12px; color:var(--muted); margin-top:2px; }
    .toggle{
      display:flex; gap:8px; align-items:center;
      padding:8px 10px; border-radius:12px; border:1px solid rgba(31,41,55,.7);
      background: rgba(17,24,38,.55);
      font-weight:800;
      color:var(--muted);
    }
    .toggle input{ width:18px; height:18px; accent-color: var(--accent2); }
    details{ margin-top:12px; }
    summary{ cursor:pointer; font-weight:900; color: var(--text); }
    table{
      width:100%;
      border-collapse: collapse;
      margin-top:10px;
      font-size: 13px;
    }
    th, td{
      border-bottom: 1px solid rgba(31,41,55,.7);
      padding: 8px 6px;
      text-align:left;
      color: var(--muted);
    }
    th{ color: var(--text); }
    .kpi{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
    }
    @media (min-width: 900px){
      .card{ grid-column: span 6; }
      .toolbar{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<header>
  <div class="title">
    <h1>üí™ Programme J√©r√©my ‚Äî Haut du corps + Abdos</h1>
    <span class="badge" id="weekLabel"></span>
    <span class="badge">‚öΩ Foot : mardi & vendredi</span>
    <span class="badge">üéØ Objectif : √©paules / pecs / bras / abdos + -poign√©es d‚Äôamour</span>
  </div>
  <p class="sub">
    3 s√©ances muscu + 1 optionnelle ‚Ä¢ Halt√®res 1‚Äì10 kg ‚Ä¢ Suivi + poids + mesures ‚Ä¢ Sauvegarde automatique.
  </p>
</header>

<div class="wrap">

  <!-- TOOLBAR -->
  <div class="toolbar">

    <div class="toolbarRow space">
      <div class="group">
        <label class="hint">
          Intensit√©
          <select class="select" id="level">
            <option value="debutant">D√©butant (reps bas + contr√¥le)</option>
            <option value="standard" selected>Standard (bon rythme)</option>
            <option value="tonique">Tonique (reps haut + peu de repos)</option>
          </select>
        </label>

        <label class="hint">
          Repos (sec)
          <select class="select" id="rest">
            <option value="60">60</option>
            <option value="75" selected>75</option>
            <option value="90">90</option>
          </select>
        </label>

        <label class="hint">
          Objectif timer
          <select class="select" id="timerMode">
            <option value="rest" selected>Repos entre s√©ries</option>
            <option value="custom">Dur√©e personnalis√©e</option>
          </select>
        </label>

        <label class="hint" id="customWrap" style="display:none">
          Dur√©e (sec)
          <input class="input" id="customSeconds" type="number" min="10" step="5" value="60" />
        </label>
      </div>

      <div class="group">
        <button class="btn-accent" id="markToday">‚úÖ Marquer la s√©ance du jour</button>
        <button class="btn-danger" id="resetWeek">üßπ R√©initialiser la semaine</button>
      </div>
    </div>

    <!-- TIMER PANEL -->
    <div class="panel">
      <div class="timerBox">
        <div class="timerLeft">
          <div class="timerDisplay">
            <div class="timerBig mono" id="timerText">01:15</div>
            <div class="timerSmall" id="timerHint">Timer pr√™t ‚Ä¢ mode: repos</div>
          </div>

          <div class="group">
            <button class="btn-blue" id="timerStart">‚ñ∂Ô∏è Start</button>
            <button class="btn-warn" id="timerPause">‚è∏ Pause</button>
            <button id="timerReset">‚ü≤ Reset</button>
          </div>

          <label class="toggle">
            <input type="checkbox" id="autoTimer" />
            Auto-timer quand je coche une s√©rie
          </label>

          <label class="toggle">
            <input type="checkbox" id="vibrate" />
            Vibration (si dispo)
          </label>

          <label class="toggle">
            <input type="checkbox" id="sound" checked />
            BIP d√©but/fin
          </label>
        </div>

        <div class="kpi" id="kpi"></div>
      </div>

      <div style="margin-top:10px">
        <div class="progress"><div class="bar" id="weekBar" style="width:0%"></div></div>
        <div class="small" style="margin-top:6px">
          üìå Astuce : vise <b>2 reps en r√©serve</b>. Forme propre > charge.
        </div>
      </div>

      <details>
        <summary>üìè Mes mesures (poids / tour de taille / historique)</summary>
        <div class="row" style="margin-top:10px">
          <label class="hint">Poids (kg)
            <input class="input" id="mWeight" type="number" min="30" max="200" step="0.1" placeholder="85.0" />
          </label>
          <label class="hint">Tour de taille (cm)
            <input class="input" id="mWaist" type="number" min="40" max="160" step="0.5" placeholder="ex: 92" />
          </label>
          <label class="hint" style="flex:1; min-width:220px">Note
            <input class="input" id="mNote" type="text" placeholder="ex: semaine charg√©e, bon sommeil‚Ä¶" style="width:100%; min-width:220px"/>
          </label>
          <button class="btn-accent" id="addMeasure">‚ûï Ajouter</button>
          <button class="btn-danger" id="clearMeasures">üóëÔ∏è Effacer historique</button>
        </div>

        <div id="measureTableWrap"></div>
      </details>
    </div>

  </div>

  <!-- CARDS -->
  <div class="grid" id="cards"></div>

  <div class="panel" style="margin-top:12px">
    ‚ö†Ô∏è <b>Note sant√©</b> : douleur inhabituelle (√©paule / bas du dos) ‚áí stoppe l‚Äôexercice et remplace-le.
    <br/>üî• <b>Abdos & poign√©es d‚Äôamour</b> : muscu + gainage + l√©ger d√©ficit calorique + r√©gularit√© (8‚Äì12 semaines).
  </div>
</div>

<script>
  // -----------------------------
  // PROGRAMME + VID√âOS
  // -----------------------------
  const program = [
    {
      day: "Lundi",
      tag: "Pecs ‚Ä¢ √âpaules ‚Ä¢ Abdos",
      note: "S√©ance principale haut du corps (volume pecs/√©paules).",
      blocks: [
        { name:"Pompes", sets:3, reps:{debutant:"8‚Äì10",standard:"10‚Äì15",tonique:"12‚Äì18"}, desc:"Gainage serr√©, poitrine vers le sol, remonte en bloc. Variante genoux si besoin.", video:"https://www.youtube.com/embed/IODxDxX7oi4" },
        { name:"D√©velopp√© couch√© au sol (halt√®res)", sets:3, reps:{debutant:"8‚Äì10",standard:"10‚Äì12",tonique:"12‚Äì15"}, desc:"Coudes ~45¬∞, contr√¥le en bas, pousse fort. Id√©al sans banc.", video:"https://www.youtube.com/embed/uUGDRwge4F8" },
        { name:"D√©velopp√© √©paules (halt√®res)", sets:3, reps:{debutant:"8‚Äì10",standard:"10‚Äì12",tonique:"12‚Äì15"}, desc:"Buste gain√©, presse au-dessus de la t√™te sans cambrer.", video:"https://www.youtube.com/embed/qEwKCR5JCog" },
        { name:"√âl√©vations lat√©rales", sets:3, reps:{debutant:"12",standard:"12‚Äì15",tonique:"15‚Äì20"}, desc:"Monte jusqu‚Äô√† l‚Äô√©paule, lent √† la descente. Charge l√©g√®re (1‚Äì6kg souvent).", video:"https://www.youtube.com/embed/3VcKaXpzqRo" },
        { name:"Gainage (planche)", sets:3, reps:{debutant:"30‚Äì40 sec",standard:"40‚Äì60 sec",tonique:"60‚Äì75 sec"}, desc:"Fesses ni trop haut ni trop bas. Respire, nombril rentr√©.", video:"https://www.youtube.com/embed/pSHjTRCQxIw" },
        { name:"Gainage lat√©ral (sp√©cial ‚Äúpoign√©es d‚Äôamour‚Äù)", sets:3, reps:{debutant:"20‚Äì30 sec / c√¥t√©",standard:"30‚Äì45 sec / c√¥t√©",tonique:"45‚Äì60 sec / c√¥t√©"}, desc:"Hanche haute, √©paule au-dessus du coude, corps align√©.", video:"https://www.youtube.com/embed/XeN4pEZZJNI" }
      ]
    },
    { day:"Mardi", tag:"‚öΩ Foot", note:"Match / entra√Ænement. Hydratation + d√Æner l√©ger.", blocks:[] },
    {
      day: "Mercredi",
      tag: "Dos ‚Ä¢ Bras ‚Ä¢ Abdos",
      note: "Posture + dos (cl√© pour ‚Äúhaut du corps qui se tient‚Äù).",
      blocks: [
        { name:"Rowing unilat√©ral (halt√®re)", sets:3, reps:{debutant:"10 / c√¥t√©",standard:"10‚Äì12 / c√¥t√©",tonique:"12‚Äì15 / c√¥t√©"}, desc:"Tire le coude vers la hanche, omoplate se serre, dos plat.", video:"https://www.youtube.com/embed/pYcpY20QaE8" },
        { name:"Rowing buste pench√© (2 halt√®res)", sets:3, reps:{debutant:"10",standard:"10‚Äì12",tonique:"12‚Äì15"}, desc:"Charni√®re de hanches, dos neutre, tire vers le bas des c√¥tes.", video:"https://www.youtube.com/embed/yJ8NTl5RaTk" },
        { name:"Curl biceps", sets:3, reps:{debutant:"10‚Äì12",standard:"12",tonique:"12‚Äì15"}, desc:"Coudes coll√©s, monte sans balancer. Contr√¥le √† la descente.", video:"https://www.youtube.com/embed/ykJmrZ5v0Oo" },
        { name:"Extension triceps au-dessus de la t√™te (1 halt√®re)", sets:3, reps:{debutant:"10‚Äì12",standard:"12",tonique:"12‚Äì15"}, desc:"Coudes serr√©s, descends derri√®re la t√™te, remonte en contr√¥lant.", video:"https://www.youtube.com/embed/2-LAMcpzODU" },
        { name:"Dead Bug (abdos profonds)", sets:3, reps:{debutant:"8 / c√¥t√©",standard:"10 / c√¥t√©",tonique:"12 / c√¥t√©"}, desc:"Bas du dos coll√© au sol, mouvements lents, respiration contr√¥l√©e.", video:"https://www.youtube.com/embed/bxn9FBrt4-A" },
        { name:"Relev√©s de jambes au sol", sets:3, reps:{debutant:"8‚Äì10",standard:"10‚Äì12",tonique:"12‚Äì15"}, desc:"Ne cambre pas : mains sous les fesses si besoin. Descente lente.", video:"https://www.youtube.com/embed/Wp4BlxcFTkE" }
      ]
    },
    {
      day: "Jeudi",
      tag: "Mix haut du corps + Gainage (plus l√©ger)",
      note: "S√©ance ‚Äúqualit√©‚Äù : technique + pompe la posture sans te cramer avant le foot.",
      blocks: [
        { name:"Pompes serr√©es (triceps + pecs)", sets:3, reps:{debutant:"6‚Äì8",standard:"8‚Äì12",tonique:"12‚Äì15"}, desc:"Mains plus proches, coudes pr√®s du corps. Variante genoux ok.", video:"https://www.youtube.com/embed/0pkjOk0EiAk" },
        { name:"D√©velopp√© √©paules (halt√®res)", sets:3, reps:{debutant:"8‚Äì10",standard:"10‚Äì12",tonique:"12‚Äì15"}, desc:"Buste gain√©, pas de cambrure.", video:"https://www.youtube.com/embed/qEwKCR5JCog" },
        { name:"Rowing unilat√©ral (halt√®re)", sets:3, reps:{debutant:"10 / c√¥t√©",standard:"10‚Äì12 / c√¥t√©",tonique:"12‚Äì15 / c√¥t√©"}, desc:"Coude vers la hanche, omoplate active.", video:"https://www.youtube.com/embed/pYcpY20QaE8" },
        { name:"√âl√©vations lat√©rales", sets:3, reps:{debutant:"12",standard:"12‚Äì15",tonique:"15‚Äì20"}, desc:"Focus largeur d‚Äô√©paules. Lenteur > charge.", video:"https://www.youtube.com/embed/3VcKaXpzqRo" },
        { name:"Mountain climbers (cardio + abdos)", sets:3, reps:{debutant:"20 sec",standard:"30 sec",tonique:"40 sec"}, desc:"Hanches stables, rythme r√©gulier.", video:"https://www.youtube.com/embed/CQk4MHY2_Tc" },
        { name:"Gainage lat√©ral", sets:3, reps:{debutant:"20‚Äì30 sec / c√¥t√©",standard:"30‚Äì45 sec / c√¥t√©",tonique:"45‚Äì60 sec / c√¥t√©"}, desc:"Alignement parfait. Hanche haute.", video:"https://www.youtube.com/embed/XeN4pEZZJNI" }
      ]
    },
    { day:"Vendredi", tag:"‚öΩ Foot", note:"Match / entra√Ænement. √âtirements + sommeil.", blocks:[] },
    {
      day:"Samedi (optionnel)",
      tag:"Abdos + finisher (15‚Äì20 min)",
      note:"Courte s√©ance pour acc√©l√©rer la perte de gras (sans t‚Äô√©puiser).",
      blocks:[
        { name:"Circuit x 3 tours (sans charge)", sets:3, reps:{debutant:"Rythme cool",standard:"Rythme r√©gulier",tonique:"Rythme soutenu"}, desc:"1) Jumping jacks 45s ‚Ä¢ 2) Mountain climbers 30s ‚Ä¢ 3) Planche 45s ‚Ä¢ 4) Russian twists 20 reps ‚Ä¢ Repos 60s", video:"https://www.youtube.com/embed/nmwgirgXLYM" }
      ]
    },
    { day:"Dimanche", tag:"Repos / marche", note:"Marche 30‚Äì60 min si possible (top pour la perte de gras).", blocks:[] }
  ];

  // -----------------------------
  // DATE SEMAINE (LUNDI -> DIMANCHE)
  // -----------------------------
  function getMonday(d=new Date()){
    const date = new Date(d);
    const day = (date.getDay()+6)%7; // Monday=0
    date.setHours(0,0,0,0);
    date.setDate(date.getDate()-day);
    return date;
  }
  const monday = getMonday();
  const sunday = new Date(monday); sunday.setDate(sunday.getDate()+6);
  const weekKey = `jeremy_week_${monday.toISOString().slice(0,10)}`;

  // -----------------------------
  // STATE + STORAGE
  // -----------------------------
  const stateDefault = {
    checks:{},           // per set checkbox
    doneDays:{},         // dayIndex => true/false
    weights:{},          // per exercise weight used
    settings:{           // timer + toggles
      autoTimer:true,
      vibrate:false,
      sound:true,
      restSeconds:75,
      timerMode:"rest",
      customSeconds:60,
      level:"standard"
    },
    measures:[]          // array of {ts, weight, waist, note}
  };

  const state = JSON.parse(localStorage.getItem(weekKey) || "null") || structuredClone(stateDefault);

  function save(){
    localStorage.setItem(weekKey, JSON.stringify(state));
    renderProgressBars();
    renderKpi();
    renderMeasures();
  }

  // -----------------------------
  // HELPERS
  // -----------------------------
  const $cards = document.getElementById("cards");
  const $weekLabel = document.getElementById("weekLabel");
  const $level = document.getElementById("level");
  const $rest = document.getElementById("rest");
  const $timerMode = document.getElementById("timerMode");
  const $customWrap = document.getElementById("customWrap");
  const $customSeconds = document.getElementById("customSeconds");
  const $autoTimer = document.getElementById("autoTimer");
  const $vibrate = document.getElementById("vibrate");
  const $sound = document.getElementById("sound");

  function fmtDate(d){
    return d.toLocaleDateString("fr-FR",{weekday:"short", day:"2-digit", month:"2-digit"});
  }
  $weekLabel.textContent = `üìÖ ${fmtDate(monday)} ‚Üí ${fmtDate(sunday)} (sauvegarde auto)`;

  function dayDateFromIndex(dayIndex){
    const d = new Date(monday);
    d.setDate(d.getDate()+dayIndex);
    return d;
  }
  function isToday(dayIndex){
    const d = dayDateFromIndex(dayIndex);
    const now = new Date();
    return d.toDateString() === now.toDateString();
  }

  function exerciseId(dayIndex, exIndex){
    return `${dayIndex}_${exIndex}`;
  }

  function totalChecksForDay(dayIndex){
    const day = program[dayIndex];
    let total = 0;
    day.blocks.forEach(b => total += b.sets);
    return total;
  }

  function checkedForDay(dayIndex){
    const day = program[dayIndex];
    let count = 0;
    day.blocks.forEach((b, exIdx)=>{
      for(let s=1; s<=b.sets; s++){
        const id = `${exerciseId(dayIndex,exIdx)}_set${s}`;
        if(state.checks[id]) count++;
      }
    });
    return count;
  }

  function totalChecksWeek(){
    let total = 0;
    for(let i=0;i<program.length;i++) total += totalChecksForDay(i);
    return total;
  }
  function checkedWeek(){
    let done = 0;
    for(let i=0;i<program.length;i++) done += checkedForDay(i);
    return done;
  }

  function sessionsDoneWeek(){
    // count only days that have blocks (muscu days) where all sets completed
    let c = 0;
    program.forEach((d, i)=>{
      if(d.blocks.length){
        const t = totalChecksForDay(i);
        const done = checkedForDay(i);
        if(t && done === t) c++;
      }
    });
    return c;
  }

  // -----------------------------
  // TIMER (BIP d√©but/fin)
  // -----------------------------
  let timerInterval = null;
  let remaining = 0;
  let running = false;

  const $timerText = document.getElementById("timerText");
  const $timerHint = document.getElementById("timerHint");

  function secondsTarget(){
    if(state.settings.timerMode === "custom") return Number(state.settings.customSeconds) || 60;
    return Number(state.settings.restSeconds) || 75;
  }

  function fmtMMSS(sec){
    const s = Math.max(0, Math.floor(sec));
    const m = Math.floor(s / 60);
    const r = s % 60;
    return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
  }

  function updateTimerUI(){
    $timerText.textContent = fmtMMSS(remaining || secondsTarget());
    const modeLabel = state.settings.timerMode === "custom" ? "perso" : "repos";
    const status = running ? "‚è≥ en cours" : "‚è∏ pr√™t";
    $timerHint.textContent = `Timer ${status} ‚Ä¢ mode: ${modeLabel}`;
  }

  // Simple bip via Web Audio (fonctionne sur mobile si interaction user avant)
  function beep(frequency=880, durationMs=120, volume=0.12){
    if(!state.settings.sound) return;
    try{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "sine";
      osc.frequency.value = frequency;
      gain.gain.value = volume;

      osc.connect(gain);
      gain.connect(ctx.destination);

      osc.start();
      setTimeout(()=>{
        osc.stop();
        ctx.close();
      }, durationMs);
    }catch(e){
      // no-op
    }
  }

  function buzz(pattern=150){
    if(state.settings.vibrate && navigator.vibrate) navigator.vibrate(pattern);
  }

  function startTimer(targetSec=null){
    const target = targetSec ?? secondsTarget();
    remaining = target;
    running = true;

    beep(740, 100); // bip d√©but
    buzz(40);

    clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
      remaining -= 1;
      if(remaining <= 0){
        remaining = 0;
        stopTimer(true);
      }
      updateTimerUI();
    }, 1000);
    updateTimerUI();
  }

  function stopTimer(finished=false){
    clearInterval(timerInterval);
    timerInterval = null;
    running = false;
    if(finished){
      beep(988, 120); // bip fin
      setTimeout(()=>beep(988, 120), 140); // double bip fin
      buzz([80,60,80]);
    }
    updateTimerUI();
  }

  function pauseTimer(){
    if(!running) return;
    clearInterval(timerInterval);
    timerInterval = null;
    running = false;
    updateTimerUI();
  }

  function resetTimer(){
    stopTimer(false);
    remaining = secondsTarget();
    updateTimerUI();
  }

  // -----------------------------
  // RENDER KPI + MEASURES
  // -----------------------------
  const $kpi = document.getElementById("kpi");
  const $weekBar = document.getElementById("weekBar");

  function renderKpi(){
    const totalW = totalChecksWeek();
    const doneW = checkedWeek();
    const pct = totalW ? Math.round((doneW/totalW)*100) : 100;
    $weekBar.style.width = `${pct}%`;

    const sessions = sessionsDoneWeek();
    const best = 4; // objectif max (3 + 1 optionnelle)
    const sessionsLabel = `${sessions}/${best} s√©ances compl√®tes`;

    $kpi.innerHTML = `
      <span class="pill ${sessions>=3?'good':'warn'}">üî• ${sessionsLabel}</span>
      <span class="pill">‚úÖ ${doneW}/${totalW} s√©ries</span>
      <span class="pill ${pct>=70?'good':(pct>=40?'warn':'bad')}">üìà ${pct}% semaine</span>
      <span class="pill">‚è±Ô∏è repos: ${state.settings.timerMode==='custom' ? (state.settings.customSeconds+'s') : (state.settings.restSeconds+'s')}</span>
    `;
  }

  const $measureTableWrap = document.getElementById("measureTableWrap");
  function renderMeasures(){
    if(!state.measures?.length){
      $measureTableWrap.innerHTML = `<div class="small" style="margin-top:10px;color:var(--muted)">Aucune mesure enregistr√©e pour cette semaine.</div>`;
      return;
    }
    const rows = [...state.measures].sort((a,b)=>b.ts-a.ts).map(m=>{
      const d = new Date(m.ts);
      const dateStr = d.toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"});
      const w = (m.weight ?? "") === "" ? "-" : `${m.weight} kg`;
      const waist = (m.waist ?? "") === "" ? "-" : `${m.waist} cm`;
      const note = (m.note ?? "").replaceAll("<","&lt;").replaceAll(">","&gt;");
      return `<tr><td>${dateStr}</td><td>${w}</td><td>${waist}</td><td>${note||"-"}</td></tr>`;
    }).join("");

    $measureTableWrap.innerHTML = `
      <table>
        <thead><tr><th>Date</th><th>Poids</th><th>Taille</th><th>Note</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  }

  // -----------------------------
  // RENDER CARDS
  // -----------------------------
  function renderProgressBars(){
    document.querySelectorAll(".bar[data-day]").forEach(bar=>{
      const dayIndex = Number(bar.dataset.day);
      const total = totalChecksForDay(dayIndex);
      const done = checkedForDay(dayIndex);
      const pct = total ? Math.round((done/total)*100) : 100;
      bar.style.width = `${pct}%`;
    });
    renderKpi();
  }

  function render(){
    $cards.innerHTML = "";
    const level = state.settings.level;

    program.forEach((day, dayIndex)=>{
      const card = document.createElement("div");
      card.className = "card";

      const head = document.createElement("div");
      head.className = "card-h";

      const h2 = document.createElement("h2");
      const d = dayDateFromIndex(dayIndex);
      h2.textContent = `${day.day} ‚Äî ${day.tag}`;

      const meta = document.createElement("div");
      meta.className = "meta";

      const pillDate = document.createElement("span");
      pillDate.className = "pill";
      pillDate.textContent = `üóìÔ∏è ${fmtDate(d)}`;

      const pillToday = document.createElement("span");
      pillToday.className = "pill good";
      pillToday.textContent = "‚≠ê Aujourd‚Äôhui";

      const total = totalChecksForDay(dayIndex);
      const done = checkedForDay(dayIndex);

      const pillCount = document.createElement("span");
      pillCount.className = "pill";
      pillCount.textContent = total ? `üìå ${done}/${total} s√©ries` : "üßò R√©cup / sport";

      meta.appendChild(pillDate);
      if(isToday(dayIndex)) meta.appendChild(pillToday);
      meta.appendChild(pillCount);

      head.appendChild(h2);
      head.appendChild(meta);

      const content = document.createElement("div");
      content.className = "content";

      const note = document.createElement("div");
      note.className = "small";
      note.textContent = day.note;
      content.appendChild(note);

      // Progress bar day
      const progWrap = document.createElement("div");
      progWrap.style.marginTop = "10px";
      const prog = document.createElement("div");
      prog.className = "progress";
      const bar = document.createElement("div");
      bar.className = "bar";
      bar.dataset.day = dayIndex;
      prog.appendChild(bar);
      progWrap.appendChild(prog);
      content.appendChild(progWrap);

      if(day.blocks.length === 0){
        const empty = document.createElement("div");
        empty.className = "ex";
        empty.innerHTML = `<div class="ex-top"><div><div class="ex-name">‚úÖ Rien √† cocher ici</div><div class="ex-desc">Profite de ton foot / r√©cup. Petite marche = bonus.</div></div></div>`;
        content.appendChild(empty);
      } else {
        day.blocks.forEach((ex, exIndex)=>{
          const exBox = document.createElement("div");
          exBox.className = "ex";

          const top = document.createElement("div");
          top.className = "ex-top";

          const left = document.createElement("div");
          left.style.minWidth = "260px";

          // weight input
          const wKey = `w_${exerciseId(dayIndex, exIndex)}`;
          const savedW = state.weights[wKey] ?? "";
          const weightHtml = `
            <label class="hint" style="display:block; margin-top:10px">
              Poids utilis√© (kg)
              <input class="input mono" style="min-width:110px" type="number" min="0" step="0.5" value="${String(savedW).replaceAll('"','&quot;')}" />
            </label>
          `;

          left.innerHTML = `
            <div class="ex-name">${ex.name}</div>
            <div class="ex-desc">${ex.desc}</div>
            <div class="row small">
              <span class="pill">üß† ${ex.sets} s√©ries</span>
              <span class="pill">üîÅ ${ex.reps[level]}</span>
              <span class="pill">‚è±Ô∏è repos ${state.settings.restSeconds}s</span>
            </div>
            ${weightHtml}
          `;

          const weightInput = left.querySelector("input");
          weightInput.addEventListener("input", ()=>{
            state.weights[wKey] = weightInput.value;
            save();
          });

          const right = document.createElement("div");
          right.innerHTML = `
            <span class="pill">üèãÔ∏è R√®gle : 2 reps en r√©serve</span>
            <span class="pill">‚úÖ Technique propre</span>
            <span class="pill">üì≤ Coche une s√©rie = timer (si auto activ√©)</span>
          `;

          top.appendChild(left);
          top.appendChild(right);

          const row = document.createElement("div");
          row.className = "row";

          for(let s=1; s<=ex.sets; s++){
            const setId = `${exerciseId(dayIndex,exIndex)}_set${s}`;
            const label = document.createElement("label");
            label.className = "check";
            label.innerHTML = `
              <input type="checkbox" ${state.checks[setId] ? "checked":""}/>
              <span>S√©rie ${s}</span>
            `;
            const cb = label.querySelector("input");
            cb.addEventListener("change", ()=>{
              state.checks[setId] = cb.checked;

              // Auto "jour fait" si tout est coch√©
              const totalDay = totalChecksForDay(dayIndex);
              const doneDay = checkedForDay(dayIndex);
              state.doneDays[dayIndex] = (totalDay && doneDay === totalDay);

              save();

              // Auto timer si on vient de cocher
              if(cb.checked && state.settings.autoTimer){
                startTimer(secondsTarget());
              }
            });
            row.appendChild(label);
          }

          // Quick timer button per exercise
          const quick = document.createElement("button");
          quick.className = "btn-blue";
          quick.textContent = "‚è±Ô∏è Repos maintenant";
          quick.addEventListener("click", ()=>startTimer(secondsTarget()));
          row.appendChild(quick);

          const iframe = document.createElement("iframe");
          iframe.className = "video";
          iframe.src = ex.video;
          iframe.title = `Vid√©o : ${ex.name}`;
          iframe.loading = "lazy";
          iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
          iframe.referrerPolicy = "strict-origin-when-cross-origin";
          iframe.allowFullscreen = true;

          exBox.appendChild(top);
          exBox.appendChild(row);
          exBox.appendChild(iframe);
          content.appendChild(exBox);
        });
      }

      card.appendChild(head);
      card.appendChild(content);
      $cards.appendChild(card);
    });

    renderProgressBars();
  }

  // -----------------------------
  // BUTTONS / UI EVENTS
  // -----------------------------
  document.getElementById("resetWeek").addEventListener("click", ()=>{
    if(confirm("R√©initialiser tous les checks (et poids/mesures) de la semaine ?")){
      const keepSettings = structuredClone(state.settings);
      Object.assign(state, structuredClone(stateDefault));
      state.settings = keepSettings; // on garde tes pr√©f√©rences timer
      save();
      render();
      resetTimer();
    }
  });

  document.getElementById("markToday").addEventListener("click", ()=>{
    const today = new Date();
    const dayIndex = ((today.getDay()+6)%7); // Monday=0
    const day = program[dayIndex];
    if(!day.blocks.length){
      alert("Aujourd‚Äôhui : foot / repos. Rien √† cocher ‚úÖ");
      return;
    }
    day.blocks.forEach((ex, exIndex)=>{
      for(let s=1; s<=ex.sets; s++){
        const setId = `${exerciseId(dayIndex,exIndex)}_set${s}`;
        state.checks[setId] = true;
      }
    });
    state.doneDays[dayIndex] = true;
    save();
    render();
  });

  // TIMER buttons
  document.getElementById("timerStart").addEventListener("click", ()=>startTimer(secondsTarget()));
  document.getElementById("timerPause").addEventListener("click", ()=>pauseTimer());
  document.getElementById("timerReset").addEventListener("click", ()=>{ resetTimer(); });

  // Measures
  document.getElementById("addMeasure").addEventListener("click", ()=>{
    const w = document.getElementById("mWeight").value;
    const waist = document.getElementById("mWaist").value;
    const note = document.getElementById("mNote").value;
    if(w==="" && waist==="" && (note||"").trim()===""){
      alert("Ajoute au moins un champ (poids, taille ou note).");
      return;
    }
    state.measures.push({
      ts: Date.now(),
      weight: w==="" ? "" : Number(w),
      waist: waist==="" ? "" : Number(waist),
      note: (note||"").trim()
    });
    document.getElementById("mNote").value = "";
    save();
  });

  document.getElementById("clearMeasures").addEventListener("click", ()=>{
    if(confirm("Effacer l‚Äôhistorique des mesures pour cette semaine ?")){
      state.measures = [];
      save();
    }
  });

  // Settings bindings
  function applySettingsToUI(){
    $level.value = state.settings.level || "standard";
    $rest.value = String(state.settings.restSeconds || 75);
    $timerMode.value = state.settings.timerMode || "rest";
    $customSeconds.value = Number(state.settings.customSeconds || 60);
    $customWrap.style.display = ($timerMode.value === "custom") ? "block" : "none";
    $autoTimer.checked = !!state.settings.autoTimer;
    $vibrate.checked = !!state.settings.vibrate;
    $sound.checked = !!state.settings.sound;
  }

  $level.addEventListener("change", ()=>{
    state.settings.level = $level.value;
    save();
    render();
  });

  $rest.addEventListener("change", ()=>{
    state.settings.restSeconds = Number($rest.value);
    save();
    resetTimer();
    renderKpi();
    renderProgressBars();
  });

  $timerMode.addEventListener("change", ()=>{
    state.settings.timerMode = $timerMode.value;
    $customWrap.style.display = ($timerMode.value === "custom") ? "block" : "none";
    save();
    resetTimer();
    renderKpi();
  });

  $customSeconds.addEventListener("change", ()=>{
    state.settings.customSeconds = Number($customSeconds.value || 60);
    save();
    resetTimer();
    renderKpi();
  });

  $autoTimer.addEventListener("change", ()=>{
    state.settings.autoTimer = $autoTimer.checked;
    save();
  });

  $vibrate.addEventListener("change", ()=>{
    state.settings.vibrate = $vibrate.checked;
    save();
  });

  $sound.addEventListener("change", ()=>{
    state.settings.sound = $sound.checked;
    save();
  });

  // -----------------------------
  // INIT
  // -----------------------------
  // If old state missing new keys, merge softly
  (function migrate(){
    state.weights = state.weights || {};
    state.settings = Object.assign(structuredClone(stateDefault.settings), state.settings || {});
    state.measures = state.measures || [];
  })();

  applySettingsToUI();
  updateTimerUI();
  renderKpi();
  renderMeasures();
  render();
  resetTimer();
</script>
</body>
</html>