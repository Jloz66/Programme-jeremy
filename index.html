<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Programme J√©r√©my ‚Äî App</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow: 0 10px 30px rgba(17,24,39,.08);
      --radius:16px;

      --green:#16a34a;
      --blue:#2563eb;
      --orange:#f59e0b;
      --red:#ef4444;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: var(--bg);
      color:var(--text);
    }
    .container{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 28px;
    }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom: 14px;
    }
    .brand h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .2px;
    }
    .brand p{
      margin:6px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }
    .topActions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .btn{
      border:1px solid var(--border);
      background: var(--card);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 800;
      box-shadow: 0 2px 10px rgba(17,24,39,.04);
    }
    .btn:hover{ border-color: rgba(37,99,235,.35); }
    .btnPrimary{
      border-color: rgba(22,163,74,.25);
      background: rgba(22,163,74,.08);
    }
    .btnDanger{
      border-color: rgba(239,68,68,.25);
      background: rgba(239,68,68,.08);
    }
    .btnBlue{
      border-color: rgba(37,99,235,.25);
      background: rgba(37,99,235,.08);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }
    .card{
      grid-column: span 12;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }
    .cardHeader h2{
      margin:0;
      font-size: 15px;
    }
    .pillRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      font-size: 12px;
      color: var(--muted);
      border:1px solid var(--border);
      background: #fff;
      padding: 6px 10px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .pill.good{ border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.08); color: #166534; }
    .pill.blue{ border-color: rgba(37,99,235,.25); background: rgba(37,99,235,.08); color: #1e40af; }
    .pill.warn{ border-color: rgba(245,158,11,.30); background: rgba(245,158,11,.10); color: #92400e; }
    .pill.bad{ border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.10); color: #7f1d1d; }

    .cardBody{ padding: 12px 14px 14px; }

    .kpiGrid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
    }
    .kpi{
      grid-column: span 12;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: #fff;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
    }
    .kpi .label{ color: var(--muted); font-size: 12px; }
    .kpi .value{ font-weight: 900; font-size: 18px; }
    .kpi .value.mono{ font-family: var(--mono); }

    .progress{
      height: 10px;
      border-radius: 999px;
      background: #eef2ff;
      border:1px solid var(--border);
      overflow:hidden;
      margin-top: 10px;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(22,163,74,.95), rgba(37,99,235,.95));
    }

    .daysGrid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .dayTile{
      grid-column: span 12;
      border:1px solid var(--border);
      border-radius: 16px;
      background: #fff;
      padding: 12px;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      box-shadow: 0 6px 18px rgba(17,24,39,.06);
    }
    .dayLeft{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 180px;
    }
    .dayTitle{
      font-weight: 900;
      font-size: 14px;
    }
    .daySub{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.2;
    }
    .dayRight{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .miniProgress{
      width: 140px;
      height: 9px;
      border-radius: 999px;
      background: #f3f4f6;
      border: 1px solid var(--border);
      overflow:hidden;
    }
    .miniBar{ height:100%; width:0%; background: linear-gradient(90deg, rgba(37,99,235,.95), rgba(22,163,74,.95)); }
    .miniCount{
      font-size:12px;
      color: var(--muted);
      min-width: 72px;
      text-align:right;
    }
    .badgeToday{
      font-size: 12px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(37,99,235,.20);
      background: rgba(37,99,235,.08);
      color: #1e40af;
    }

    /* SESSION VIEW */
    .view{ display:none; }
    .view.active{ display:block; }

    .sessionTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin: 8px 0 12px;
    }
    .sessionTitle h2{
      margin:0;
      font-size: 16px;
    }
    .muted{ color: var(--muted); font-size: 13px; line-height: 1.35; }

    .exercise{
      border:1px solid var(--border);
      border-radius: 16px;
      background: #fff;
      padding: 12px;
      margin-top: 10px;
      box-shadow: 0 6px 18px rgba(17,24,39,.06);
    }
    .exTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }
    .exName{
      font-weight: 950;
      font-size: 14px;
    }
    .exDesc{
      margin-top: 6px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
      max-width: 700px;
    }
    .exMeta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top: 8px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }
    .check{
      display:flex;
      align-items:center;
      gap:8px;
      border: 1px solid var(--border);
      background: #fff;
      padding: 8px 10px;
      border-radius: 12px;
      cursor:pointer;
      user-select:none;
    }
    input[type="checkbox"]{ width:18px; height:18px; accent-color: var(--green); }
    .video{
      width:100%;
      aspect-ratio: 16/9;
      border: 1px solid var(--border);
      border-radius: 14px;
      margin-top: 10px;
    }

    /* TIMER */
    .timer{
      border:1px solid var(--border);
      border-radius: 16px;
      background: #fff;
      padding: 12px;
      box-shadow: 0 6px 18px rgba(17,24,39,.06);
    }
    .timerTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    .timerValue{
      font-family: var(--mono);
      font-size: 22px;
      font-weight: 950;
      letter-spacing: .3px;
    }
    .timerHint{ color: var(--muted); font-size: 12px; margin-top: 4px; }
    .select, .input{
      border:1px solid var(--border);
      background: #fff;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 800;
      min-width: 160px;
    }
    .input{ min-width: 120px; }

    .twoCol{
      display:grid;
      grid-template-columns: repeat(12,1fr);
      gap:12px;
    }
    .col6{ grid-column: span 12; }

    @media (min-width: 760px){
      .kpi{ grid-column: span 6; }
      .dayTile{ grid-column: span 6; }
      .col6{ grid-column: span 6; }
    }

    .divider{ height:1px; background: var(--border); margin: 10px 0; }

    .table{
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    .table th, .table td{
      border-bottom: 1px solid var(--border);
      padding: 8px 6px;
      text-align:left;
    }
    .table th{ font-weight: 900; }
    .table td{ color: var(--muted); }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(17,24,39,.92);
      color: #fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease;
    }
    .toast.show{ opacity:1; }
  </style>
</head>
<body>
  <div class="container">

    <header>
      <div class="brand">
        <h1>Programme J√©r√©my ‚Äî App</h1>
        <p>Interface claire ‚Ä¢ Vue mois + semaine ‚Ä¢ Un clic = ta s√©ance ‚Ä¢ Sauvegarde automatique</p>
      </div>
      <div class="topActions">
        <button class="btn btnBlue" id="goToday">üìå Aller √† aujourd‚Äôhui</button>
        <button class="btn btnDanger" id="resetAll">üßπ Reset (mois)</button>
      </div>
    </header>

    <!-- VIEW: HOME -->
    <section class="view active" id="viewHome">
      <div class="grid">
        <div class="card">
          <div class="cardHeader">
            <div>
              <h2>üìä Dashboard du mois</h2>
              <div class="muted" id="monthLabel"></div>
            </div>
            <div class="pillRow" id="monthPills"></div>
          </div>

          <div class="cardBody">
            <div class="kpiGrid">
              <div class="kpi">
                <div>
                  <div class="label">S√©ances compl√®tes (muscu)</div>
                  <div class="value" id="kpiSessions">0</div>
                </div>
                <span class="pill good">objectif: 12+</span>
              </div>

              <div class="kpi">
                <div>
                  <div class="label">S√©ries compl√©t√©es</div>
                  <div class="value mono" id="kpiSets">0/0</div>
                </div>
                <span class="pill blue" id="kpiPct">0%</span>
              </div>

              <div class="kpi">
                <div>
                  <div class="label">Poids (dernier)</div>
                  <div class="value mono" id="kpiWeight">‚Äî</div>
                </div>
                <span class="pill">kg</span>
              </div>

              <div class="kpi">
                <div>
                  <div class="label">Tour de taille (dernier)</div>
                  <div class="value mono" id="kpiWaist">‚Äî</div>
                </div>
                <span class="pill">cm</span>
              </div>
            </div>

            <div class="progress" aria-label="progression du mois">
              <div class="bar" id="monthBar" style="width:0%"></div>
            </div>

            <div class="divider"></div>

            <div class="twoCol">
              <div class="col6">
                <h3 style="margin:0;font-size:14px;">üóìÔ∏è Semaine en cours</h3>
                <div class="muted" id="weekLabel" style="margin-top:6px;"></div>
                <div class="daysGrid" id="daysGrid"></div>
              </div>

              <div class="col6">
                <h3 style="margin:0;font-size:14px;">üìè Mes mesures</h3>
                <div class="muted" style="margin-top:6px;">Ajoute ton poids / taille, √ßa alimente le dashboard du mois.</div>

                <div class="exercise" style="margin-top:10px;">
                  <div class="row">
                    <label class="muted" style="font-size:12px;">Poids (kg)
                      <input class="input" id="mWeight" type="number" min="30" max="200" step="0.1" placeholder="ex: 85.0" />
                    </label>
                    <label class="muted" style="font-size:12px;">Tour de taille (cm)
                      <input class="input" id="mWaist" type="number" min="40" max="160" step="0.5" placeholder="ex: 92" />
                    </label>
                    <label class="muted" style="font-size:12px; flex:1; min-width:220px;">Note
                      <input class="input" id="mNote" type="text" placeholder="ex: bonne √©nergie / fatigue‚Ä¶" style="width:100%; min-width:220px;" />
                    </label>
                  </div>
                  <div class="row" style="justify-content:flex-end;">
                    <button class="btn btnPrimary" id="addMeasure">‚ûï Ajouter</button>
                  </div>
                </div>

                <div class="exercise">
                  <div class="pillRow">
                    <span class="pill">Historique (mois)</span>
                    <button class="btn btnDanger" id="clearMeasures">üóëÔ∏è Effacer</button>
                  </div>
                  <div id="measureTableWrap"></div>
                </div>

                <div class="exercise">
                  <div class="pillRow">
                    <span class="pill warn">‚öΩ Foot mardi & vendredi</span>
                    <span class="pill">üéØ Objectif: r√©gularit√© 8‚Äì12 semaines</span>
                  </div>
                  <div class="muted" style="margin-top:8px;">
                    Astuce : vise <b>2 reps en r√©serve</b> et une ex√©cution propre. Progression = constance.
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- VIEW: SESSION -->
    <section class="view" id="viewSession">
      <div class="sessionTitle">
        <div>
          <h2 id="sessionTitle">S√©ance</h2>
          <div class="muted" id="sessionSubtitle"></div>
        </div>
        <div class="pillRow">
          <button class="btn" id="backHome">‚Üê Retour</button>
          <button class="btn btnPrimary" id="markDayDone">‚úÖ Tout cocher</button>
        </div>
      </div>

      <div class="twoCol">
        <div class="col6">
          <div class="timer">
            <div class="timerTop">
              <div>
                <div class="timerValue" id="timerText">01:15</div>
                <div class="timerHint" id="timerHint">Timer pr√™t</div>
              </div>
              <div class="pillRow">
                <button class="btn btnBlue" id="timerStart">‚ñ∂ Start</button>
                <button class="btn" id="timerPause">‚è∏ Pause</button>
                <button class="btn" id="timerReset">‚ü≤ Reset</button>
              </div>
            </div>

            <div class="divider"></div>

            <div class="row">
              <label class="muted" style="font-size:12px;">Repos (sec)
                <select class="select" id="rest">
                  <option value="60">60</option>
                  <option value="75" selected>75</option>
                  <option value="90">90</option>
                </select>
              </label>

              <label class="muted" style="font-size:12px;">Intensit√©
                <select class="select" id="level">
                  <option value="debutant">D√©butant</option>
                  <option value="standard" selected>Standard</option>
                  <option value="tonique">Tonique</option>
                </select>
              </label>

              <label class="muted" style="font-size:12px;">
                <input type="checkbox" id="autoTimer" style="vertical-align:middle;margin-right:6px;">
                Auto-timer quand je coche une s√©rie
              </label>

              <label class="muted" style="font-size:12px;">
                <input type="checkbox" id="sound" checked style="vertical-align:middle;margin-right:6px;">
                Bip d√©but/fin
              </label>
            </div>

            <div class="progress" style="margin-top:12px;">
              <div class="bar" id="dayBar" style="width:0%"></div>
            </div>
            <div class="muted" style="margin-top:8px;" id="dayProgressLabel">0/0 s√©ries</div>
          </div>
        </div>

        <div class="col6">
          <div class="exercise">
            <div class="pillRow" id="sessionPills"></div>
            <div class="muted" style="margin-top:10px;" id="sessionNote"></div>
          </div>
        </div>
      </div>

      <div id="sessionExercises"></div>
    </section>

  </div>

  <div class="toast" id="toast">Sauvegard√© ‚úÖ</div>

<script>
  // -----------------------------
  // PROGRAMME
  // -----------------------------
  const program = [
    {
      day: "Lundi",
      tag: "Pecs ‚Ä¢ √âpaules ‚Ä¢ Abdos",
      note: "S√©ance principale haut du corps (volume pecs/√©paules).",
      blocks: [
        { name:"Pompes", sets:3, reps:{debutant:"8‚Äì10",standard:"10‚Äì15",tonique:"12‚Äì18"}, desc:"Gainage serr√©, poitrine vers le sol, remonte en bloc. Variante genoux si besoin.", video:"https://www.youtube.com/embed/IODxDxX7oi4" },
        { name:"D√©velopp√© couch√© au sol (halt√®res)", sets:3, reps:{debutant:"8‚Äì10",standard:"10‚Äì12",tonique:"12‚Äì15"}, desc:"Coudes ~45¬∞, contr√¥le en bas, pousse fort. Id√©al sans banc.", video:"https://www.youtube.com/embed/uUGDRwge4F8" },
        { name:"D√©velopp√© √©paules (halt√®res)", sets:3, reps:{debutant:"8‚Äì10",standard:"10‚Äì12",tonique:"12‚Äì15"}, desc:"Buste gain√©, presse au-dessus de la t√™te sans cambrer.", video:"https://www.youtube.com/embed/qEwKCR5JCog" },
        { name:"√âl√©vations lat√©rales", sets:3, reps:{debutant:"12",standard:"12‚Äì15",tonique:"15‚Äì20"}, desc:"Monte jusqu‚Äô√† l‚Äô√©paule, lent √† la descente. Charge l√©g√®re (1‚Äì6kg souvent).", video:"https://www.youtube.com/embed/3VcKaXpzqRo" },
        { name:"Gainage (planche)", sets:3, reps:{debutant:"30‚Äì40 sec",standard:"40‚Äì60 sec",tonique:"60‚Äì75 sec"}, desc:"Fesses ni trop haut ni trop bas. Respire, nombril rentr√©.", video:"https://www.youtube.com/embed/pSHjTRCQxIw" },
        { name:"Gainage lat√©ral", sets:3, reps:{debutant:"20‚Äì30 sec / c√¥t√©",standard:"30‚Äì45 sec / c√¥t√©",tonique:"45‚Äì60 sec / c√¥t√©"}, desc:"Hanche haute, √©paule au-dessus du coude, corps align√©.", video:"https://www.youtube.com/embed/XeN4pEZZJNI" }
      ]
    },
    { day:"Mardi", tag:"‚öΩ Foot", note:"Match / entra√Ænement. Hydratation + d√Æner l√©ger.", blocks:[] },
    {
      day: "Mercredi",
      tag: "Dos ‚Ä¢ Bras ‚Ä¢ Abdos",
      note: "Posture + dos (cl√© pour un haut du corps qui se tient).",
      blocks: [
        { name:"Rowing unilat√©ral (halt√®re)", sets:3, reps:{debutant:"10 / c√¥t√©",standard:"10‚Äì12 / c√¥t√©",tonique:"12‚Äì15 / c√¥t√©"}, desc:"Tire le coude vers la hanche, omoplate se serre, dos plat.", video:"https://www.youtube.com/embed/pYcpY20QaE8" },
        { name:"Rowing buste pench√© (2 halt√®res)", sets:3, reps:{debutant:"10",standard:"10‚Äì12",tonique:"12‚Äì15"}, desc:"Charni√®re de hanches, dos neutre, tire vers le bas des c√¥tes.", video:"https://www.youtube.com/embed/yJ8NTl5RaTk" },
        { name:"Curl biceps", sets:3, reps:{debutant:"10‚Äì12",standard:"12",tonique:"12‚Äì15"}, desc:"Coudes coll√©s, monte sans balancer. Contr√¥le √† la descente.", video:"https://www.youtube.com/embed/ykJmrZ5v0Oo" },
        { name:"Extension triceps au-dessus de la t√™te (1 halt√®re)", sets:3, reps:{debutant:"10‚Äì12",standard:"12",tonique:"12‚Äì15"}, desc:"Coudes serr√©s, descends derri√®re la t√™te, remonte en contr√¥lant.", video:"https://www.youtube.com/embed/2-LAMcpzODU" },
        { name:"Dead Bug", sets:3, reps:{debutant:"8 / c√¥t√©",standard:"10 / c√¥t√©",tonique:"12 / c√¥t√©"}, desc:"Bas du dos coll√© au sol, mouvements lents, respiration contr√¥l√©e.", video:"https://www.youtube.com/embed/bxn9FBrt4-A" },
        { name:"Relev√©s de jambes au sol", sets:3, reps:{debutant:"8‚Äì10",standard:"10‚Äì12",tonique:"12‚Äì15"}, desc:"Ne cambre pas : mains sous les fesses si besoin. Descente lente.", video:"https://www.youtube.com/embed/Wp4BlxcFTkE" }
      ]
    },
    {
      day: "Jeudi",
      tag: "Mix (l√©ger) + Gainage",
      note: "S√©ance ‚Äúqualit√©‚Äù : technique + posture sans te cramer avant le foot.",
      blocks: [
        { name:"Pompes serr√©es", sets:3, reps:{debutant:"6‚Äì8",standard:"8‚Äì12",tonique:"12‚Äì15"}, desc:"Mains plus proches, coudes pr√®s du corps. Variante genoux OK.", video:"https://www.youtube.com/embed/0pkjOk0EiAk" },
        { name:"D√©velopp√© √©paules (halt√®res)", sets:3, reps:{debutant:"8‚Äì10",standard:"10‚Äì12",tonique:"12‚Äì15"}, desc:"Buste gain√©, pas de cambrure.", video:"https://www.youtube.com/embed/qEwKCR5JCog" },
        { name:"Rowing unilat√©ral (halt√®re)", sets:3, reps:{debutant:"10 / c√¥t√©",standard:"10‚Äì12 / c√¥t√©",tonique:"12‚Äì15 / c√¥t√©"}, desc:"Coude vers la hanche, omoplate active.", video:"https://www.youtube.com/embed/pYcpY20QaE8" },
        { name:"√âl√©vations lat√©rales", sets:3, reps:{debutant:"12",standard:"12‚Äì15",tonique:"15‚Äì20"}, desc:"Largeur d‚Äô√©paules. Lenteur > charge.", video:"https://www.youtube.com/embed/3VcKaXpzqRo" },
        { name:"Mountain climbers", sets:3, reps:{debutant:"20 sec",standard:"30 sec",tonique:"40 sec"}, desc:"Hanches stables, rythme r√©gulier.", video:"https://www.youtube.com/embed/CQk4MHY2_Tc" },
        { name:"Gainage lat√©ral", sets:3, reps:{debutant:"20‚Äì30 sec / c√¥t√©",standard:"30‚Äì45 sec / c√¥t√©",tonique:"45‚Äì60 sec / c√¥t√©"}, desc:"Alignement parfait. Hanche haute.", video:"https://www.youtube.com/embed/XeN4pEZZJNI" }
      ]
    },
    { day:"Vendredi", tag:"‚öΩ Foot", note:"Match / entra√Ænement. √âtirements + sommeil.", blocks:[] },
    {
      day:"Samedi (optionnel)",
      tag:"Abdos + finisher (15‚Äì20 min)",
      note:"Courte s√©ance pour acc√©l√©rer la perte de gras (sans t‚Äô√©puiser).",
      blocks:[
        { name:"Circuit x 3 tours", sets:3, reps:{debutant:"Rythme cool",standard:"Rythme r√©gulier",tonique:"Rythme soutenu"}, desc:"1) Jumping jacks 45s ‚Ä¢ 2) Mountain climbers 30s ‚Ä¢ 3) Planche 45s ‚Ä¢ 4) Russian twists 20 reps ‚Ä¢ Repos 60s", video:"https://www.youtube.com/embed/nmwgirgXLYM" }
      ]
    },
    { day:"Dimanche", tag:"Repos / marche", note:"Marche 30‚Äì60 min si possible (top pour la perte de gras).", blocks:[] }
  ];

  // -----------------------------
  // DATE HELPERS
  // -----------------------------
  function getMonday(d=new Date()){
    const date = new Date(d);
    const day = (date.getDay()+6)%7; // Monday=0
    date.setHours(0,0,0,0);
    date.setDate(date.getDate()-day);
    return date;
  }
  function fmtDateShort(d){
    return d.toLocaleDateString("fr-FR",{weekday:"short", day:"2-digit", month:"2-digit"});
  }
  function dayDateFromIndex(monday, dayIndex){
    const d = new Date(monday);
    d.setDate(d.getDate()+dayIndex);
    return d;
  }
  function isToday(dayDate){
    const now = new Date();
    return dayDate.toDateString() === now.toDateString();
  }
  function pad2(n){ return String(n).padStart(2,'0'); }

  // month key
  function monthKey(d=new Date()){
    const y = d.getFullYear();
    const m = pad2(d.getMonth()+1);
    return `jeremy_month_${y}-${m}`;
  }

  // -----------------------------
  // STORAGE MODEL
  // -----------------------------
  const stateDefault = {
    settings:{
      restSeconds: 75,
      level: "standard",
      autoTimer: true,
      sound: true
    },
    // weeks: { [weekKey]: { checks:{}, weights:{} } }
    weeks: {},
    // measures: [{ts, weight, waist, note}]
    measures: []
  };

  const MKEY = monthKey(new Date());
  const state = JSON.parse(localStorage.getItem(MKEY) || "null") || structuredClone(stateDefault);

  function save(){
    localStorage.setItem(MKEY, JSON.stringify(state));
    toast("Sauvegard√© ‚úÖ");
  }

  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(toast._to);
    toast._to = setTimeout(()=>t.classList.remove("show"), 900);
  }

  function getWeekKey(monday){
    return `week_${monday.toISOString().slice(0,10)}`;
  }

  function weekState(monday){
    const wk = getWeekKey(monday);
    if(!state.weeks[wk]){
      state.weeks[wk] = { checks:{}, weights:{} };
    }
    return state.weeks[wk];
  }

  // -----------------------------
  // MONTH AGGREGATION
  // -----------------------------
  function totalSetsInProgramDay(dayIndex){
    return program[dayIndex].blocks.reduce((acc,b)=>acc+b.sets,0);
  }

  function computeMonthStats(){
    let totalSets = 0;
    let doneSets = 0;
    let fullSessions = 0;

    // Count over all stored weeks in this month
    const weekKeys = Object.keys(state.weeks || {});
    for(const wk of weekKeys){
      const w = state.weeks[wk];
      // total possible: 7 days * sets each day
      for(let dayIndex=0; dayIndex<program.length; dayIndex++){
        const totalDay = totalSetsInProgramDay(dayIndex);
        totalSets += totalDay;

        // done for that day in this week:
        let doneDay = 0;
        program[dayIndex].blocks.forEach((ex, exIndex)=>{
          for(let s=1; s<=ex.sets; s++){
            const id = `${wk}_${dayIndex}_${exIndex}_set${s}`;
            if(w.checks[id]) doneDay++;
          }
        });
        doneSets += doneDay;

        // full session count only muscu days (with blocks)
        if(totalDay > 0 && doneDay === totalDay) fullSessions++;
      }
    }

    const pct = totalSets ? Math.round((doneSets/totalSets)*100) : 0;

    // latest measure
    const measures = [...(state.measures||[])].sort((a,b)=>b.ts-a.ts);
    const last = measures[0] || null;

    return {
      totalSets, doneSets, pct,
      fullSessions,
      lastWeight: last?.weight ?? null,
      lastWaist: last?.waist ?? null
    };
  }

  // -----------------------------
  // VIEWS
  // -----------------------------
  const viewHome = document.getElementById("viewHome");
  const viewSession = document.getElementById("viewSession");

  function showHome(){
    viewSession.classList.remove("active");
    viewHome.classList.add("active");
  }
  function showSession(){
    viewHome.classList.remove("active");
    viewSession.classList.add("active");
  }

  // -----------------------------
  // HOME RENDER
  // -----------------------------
  const $monthLabel = document.getElementById("monthLabel");
  const $monthPills = document.getElementById("monthPills");
  const $kpiSessions = document.getElementById("kpiSessions");
  const $kpiSets = document.getElementById("kpiSets");
  const $kpiPct = document.getElementById("kpiPct");
  const $kpiWeight = document.getElementById("kpiWeight");
  const $kpiWaist = document.getElementById("kpiWaist");
  const $monthBar = document.getElementById("monthBar");

  const $weekLabel = document.getElementById("weekLabel");
  const $daysGrid = document.getElementById("daysGrid");

  let currentMonday = getMonday(new Date());

  function renderHome(){
    const now = new Date();
    const monthName = now.toLocaleDateString("fr-FR",{month:"long", year:"numeric"});
    $monthLabel.textContent = `üìÖ ${monthName.charAt(0).toUpperCase()+monthName.slice(1)} ‚Ä¢ donn√©es sauvegard√©es dans ce navigateur`;

    const stats = computeMonthStats();

    $kpiSessions.textContent = String(stats.fullSessions);
    $kpiSets.textContent = `${stats.doneSets}/${stats.totalSets}`;
    $kpiPct.textContent = `${stats.pct}%`;
    $monthBar.style.width = `${stats.pct}%`;

    $kpiWeight.textContent = (stats.lastWeight==null ? "‚Äî" : String(stats.lastWeight));
    $kpiWaist.textContent = (stats.lastWaist==null ? "‚Äî" : String(stats.lastWaist));

    $monthPills.innerHTML = `
      <span class="pill blue">‚è± repos: ${state.settings.restSeconds}s</span>
      <span class="pill">üèã intensit√©: ${state.settings.level}</span>
      <span class="pill ${stats.pct>=70?'good':(stats.pct>=40?'warn':'bad')}">üìà progression: ${stats.pct}%</span>
    `;

    // week label
    const sunday = new Date(currentMonday); sunday.setDate(sunday.getDate()+6);
    $weekLabel.textContent = `${fmtDateShort(currentMonday)} ‚Üí ${fmtDateShort(sunday)}`;

    // day tiles
    const wk = weekState(currentMonday);
    const wkKey = getWeekKey(currentMonday);

    $daysGrid.innerHTML = "";
    for(let dayIndex=0; dayIndex<program.length; dayIndex++){
      const day = program[dayIndex];
      const d = dayDateFromIndex(currentMonday, dayIndex);

      const totalDay = totalSetsInProgramDay(dayIndex);
      let doneDay = 0;

      day.blocks.forEach((ex, exIndex)=>{
        for(let s=1; s<=ex.sets; s++){
          const id = `${wkKey}_${dayIndex}_${exIndex}_set${s}`;
          if(wk.checks[id]) doneDay++;
        }
      });

      const pct = totalDay ? Math.round((doneDay/totalDay)*100) : 100;

      const tile = document.createElement("div");
      tile.className = "dayTile";
      tile.innerHTML = `
        <div class="dayLeft">
          <div class="dayTitle">${day.day} ‚Äî ${day.tag}</div>
          <div class="daySub">üóì ${fmtDateShort(d)} ‚Ä¢ ${day.blocks.length ? 's√©ance' : 'repos / foot'}</div>
        </div>
        <div class="dayRight">
          ${isToday(d) ? `<span class="badgeToday">Aujourd‚Äôhui</span>` : ``}
          <div class="miniProgress"><div class="miniBar" style="width:${pct}%"></div></div>
          <div class="miniCount">${day.blocks.length ? `${doneDay}/${totalDay}` : `‚Äî`}</div>
          <span class="pill ${pct>=70?'good':(pct>=40?'warn':'bad')}">${pct}%</span>
        </div>
      `;
      tile.addEventListener("click", ()=>openSession(dayIndex));
      $daysGrid.appendChild(tile);
    }

    renderMeasuresTable();
  }

  // -----------------------------
  // MEASURES
  // -----------------------------
  const $measureTableWrap = document.getElementById("measureTableWrap");
  function renderMeasuresTable(){
    const measures = [...(state.measures||[])].sort((a,b)=>b.ts-a.ts);
    if(!measures.length){
      $measureTableWrap.innerHTML = `<div class="muted" style="margin-top:10px;">Aucune mesure enregistr√©e ce mois-ci.</div>`;
      return;
    }
    const rows = measures.map(m=>{
      const d = new Date(m.ts);
      const ds = d.toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",hour:"2-digit",minute:"2-digit"});
      const w = (m.weight==null || m.weight==="") ? "‚Äî" : `${m.weight}`;
      const waist = (m.waist==null || m.waist==="") ? "‚Äî" : `${m.waist}`;
      const note = (m.note||"").replaceAll("<","&lt;").replaceAll(">","&gt;");
      return `<tr><td>${ds}</td><td>${w}</td><td>${waist}</td><td>${note||"‚Äî"}</td></tr>`;
    }).join("");

    $measureTableWrap.innerHTML = `
      <table class="table">
        <thead><tr><th>Date</th><th>Poids</th><th>Taille</th><th>Note</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  }

  document.getElementById("addMeasure").addEventListener("click", ()=>{
    const w = document.getElementById("mWeight").value;
    const waist = document.getElementById("mWaist").value;
    const note = document.getElementById("mNote").value;

    if(w==="" && waist==="" && (note||"").trim()===""){
      alert("Ajoute au moins un champ (poids, taille ou note).");
      return;
    }
    state.measures.push({
      ts: Date.now(),
      weight: w==="" ? "" : Number(w),
      waist: waist==="" ? "" : Number(waist),
      note: (note||"").trim()
    });
    document.getElementById("mNote").value = "";
    save();
    renderHome();
  });

  document.getElementById("clearMeasures").addEventListener("click", ()=>{
    if(confirm("Effacer tout l‚Äôhistorique de mesures du mois ?")){
      state.measures = [];
      save();
      renderHome();
    }
  });

  // -----------------------------
  // SESSION VIEW RENDER
  // -----------------------------
  const $sessionTitle = document.getElementById("sessionTitle");
  const $sessionSubtitle = document.getElementById("sessionSubtitle");
  const $sessionPills = document.getElementById("sessionPills");
  const $sessionNote = document.getElementById("sessionNote");
  const $sessionExercises = document.getElementById("sessionExercises");

  const $rest = document.getElementById("rest");
  const $level = document.getElementById("level");
  const $autoTimer = document.getElementById("autoTimer");
  const $sound = document.getElementById("sound");

  const $dayBar = document.getElementById("dayBar");
  const $dayProgressLabel = document.getElementById("dayProgressLabel");

  let currentDayIndex = 0;

  function sessionIds(wkKey, dayIndex, exIndex, setNum){
    return `${wkKey}_${dayIndex}_${exIndex}_set${setNum}`;
  }

  function dayCounts(dayIndex){
    const wkKey = getWeekKey(currentMonday);
    const wk = weekState(currentMonday);
    const total = totalSetsInProgramDay(dayIndex);
    let done = 0;

    program[dayIndex].blocks.forEach((ex, exIndex)=>{
      for(let s=1; s<=ex.sets; s++){
        const id = sessionIds(wkKey, dayIndex, exIndex, s);
        if(wk.checks[id]) done++;
      }
    });

    return { total, done, pct: total ? Math.round((done/total)*100) : 100 };
  }

  function renderDayProgress(){
    const c = dayCounts(currentDayIndex);
    $dayBar.style.width = `${c.pct}%`;
    $dayProgressLabel.textContent = `${c.done}/${c.total} s√©ries ‚Ä¢ ${c.pct}%`;
  }

  function openSession(dayIndex){
    currentDayIndex = dayIndex;
    const day = program[dayIndex];
    const d = dayDateFromIndex(currentMonday, dayIndex);

    $sessionTitle.textContent = `${day.day} ‚Äî ${day.tag}`;
    $sessionSubtitle.textContent = `üóì ${fmtDateShort(d)} ‚Ä¢ ${day.blocks.length ? "S√©ance" : "Repos / Foot"}`;

    $sessionPills.innerHTML = `
      ${isToday(d) ? `<span class="pill blue">üìå Aujourd‚Äôhui</span>` : ``}
      <span class="pill">‚è± repos: ${state.settings.restSeconds}s</span>
      <span class="pill">üèã intensit√©: ${state.settings.level}</span>
    `;
    $sessionNote.textContent = day.note;

    // apply settings to UI
    $rest.value = String(state.settings.restSeconds || 75);
    $level.value = state.settings.level || "standard";
    $autoTimer.checked = !!state.settings.autoTimer;
    $sound.checked = !!state.settings.sound;

    // render exercises
    $sessionExercises.innerHTML = "";

    if(!day.blocks.length){
      const box = document.createElement("div");
      box.className = "exercise";
      box.innerHTML = `
        <div class="exName">‚úÖ Rien √† faire ici</div>
        <div class="exDesc">Foot / repos. Si tu veux optimiser : marche 30‚Äì45 min + hydratation + sommeil.</div>
      `;
      $sessionExercises.appendChild(box);
    } else {
      const wkKey = getWeekKey(currentMonday);
      const wk = weekState(currentMonday);

      day.blocks.forEach((ex, exIndex)=>{
        const exBox = document.createElement("div");
        exBox.className = "exercise";

        const meta = `
          <span class="pill">üß† ${ex.sets} s√©ries</span>
          <span class="pill">üîÅ ${ex.reps[state.settings.level || "standard"]}</span>
          <span class="pill">‚è± repos ${state.settings.restSeconds || 75}s</span>
        `;

        exBox.innerHTML = `
          <div class="exTop">
            <div>
              <div class="exName">${ex.name}</div>
              <div class="exDesc">${ex.desc}</div>
              <div class="exMeta">${meta}</div>
            </div>
            <div class="pillRow">
              <span class="pill good">2 reps en r√©serve</span>
              <span class="pill">technique propre</span>
            </div>
          </div>

          <div class="row" id="sets_${exIndex}"></div>

          <iframe class="video"
            src="${ex.video}"
            title="Vid√©o : ${ex.name}"
            loading="lazy"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            referrerpolicy="strict-origin-when-cross-origin"
            allowfullscreen></iframe>
        `;

        const setsRow = exBox.querySelector(`#sets_${exIndex}`);
        for(let s=1; s<=ex.sets; s++){
          const id = sessionIds(wkKey, dayIndex, exIndex, s);
          const label = document.createElement("label");
          label.className = "check";
          label.innerHTML = `
            <input type="checkbox" ${wk.checks[id] ? "checked":""} />
            <span>S√©rie ${s}</span>
          `;
          const cb = label.querySelector("input");
          cb.addEventListener("change", ()=>{
            wk.checks[id] = cb.checked;
            save();
            renderDayProgress();
            renderHome(); // update dashboard in background
            if(cb.checked && state.settings.autoTimer){
              startTimer(state.settings.restSeconds || 75);
            }
          });
          setsRow.appendChild(label);
        }

        const quick = document.createElement("button");
        quick.className = "btn btnBlue";
        quick.textContent = "‚è± Repos maintenant";
        quick.addEventListener("click", ()=>startTimer(state.settings.restSeconds || 75));
        setsRow.appendChild(quick);

        $sessionExercises.appendChild(exBox);
      });
    }

    renderDayProgress();
    resetTimer();
    showSession();
    window.scrollTo({top:0, behavior:"smooth"});
  }

  document.getElementById("backHome").addEventListener("click", ()=>{
    showHome();
    window.scrollTo({top:0, behavior:"smooth"});
  });

  document.getElementById("markDayDone").addEventListener("click", ()=>{
    const day = program[currentDayIndex];
    if(!day.blocks.length){
      alert("Jour foot/repos : rien √† cocher ‚úÖ");
      return;
    }
    const wkKey = getWeekKey(currentMonday);
    const wk = weekState(currentMonday);

    day.blocks.forEach((ex, exIndex)=>{
      for(let s=1; s<=ex.sets; s++){
        const id = sessionIds(wkKey, currentDayIndex, exIndex, s);
        wk.checks[id] = true;
      }
    });
    save();
    renderDayProgress();
    renderHome();
    toast("S√©ance coch√©e ‚úÖ");
  });

  // -----------------------------
  // SETTINGS
  // -----------------------------
  $rest.addEventListener("change", ()=>{
    state.settings.restSeconds = Number($rest.value || 75);
    save();
    renderDayProgress();
    renderHome();
    resetTimer();
  });
  $level.addEventListener("change", ()=>{
    state.settings.level = $level.value || "standard";
    save();
    renderHome();
    // rerender session for reps display
    openSession(currentDayIndex);
  });
  $autoTimer.addEventListener("change", ()=>{
    state.settings.autoTimer = $autoTimer.checked;
    save();
  });
  $sound.addEventListener("change", ()=>{
    state.settings.sound = $sound.checked;
    save();
  });

  // -----------------------------
  // TIMER
  // -----------------------------
  let timerInterval = null;
  let remaining = 0;
  let running = false;

  const $timerText = document.getElementById("timerText");
  const $timerHint = document.getElementById("timerHint");

  function fmtMMSS(sec){
    const s = Math.max(0, Math.floor(sec));
    const m = Math.floor(s / 60);
    const r = s % 60;
    return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
  }

  function updateTimerUI(){
    const base = (remaining || state.settings.restSeconds || 75);
    $timerText.textContent = fmtMMSS(base);
    $timerHint.textContent = running ? "‚è≥ en cours" : "‚è∏ pr√™t";
  }

  function beep(frequency=880, durationMs=120, volume=0.12){
    if(!state.settings.sound) return;
    try{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "sine";
      osc.frequency.value = frequency;
      gain.gain.value = volume;
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      setTimeout(()=>{ osc.stop(); ctx.close(); }, durationMs);
    }catch(e){}
  }

  function startTimer(targetSec){
    remaining = Number(targetSec || state.settings.restSeconds || 75);
    running = true;

    beep(740, 100);
    clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
      remaining -= 1;
      if(remaining <= 0){
        remaining = 0;
        stopTimer(true);
      }
      updateTimerUI();
    }, 1000);
    updateTimerUI();
  }

  function stopTimer(finished){
    clearInterval(timerInterval);
    timerInterval = null;
    running = false;
    if(finished){
      beep(988, 120);
      setTimeout(()=>beep(988, 120), 140);
    }
    updateTimerUI();
  }

  function pauseTimer(){
    if(!running) return;
    clearInterval(timerInterval);
    timerInterval = null;
    running = false;
    updateTimerUI();
  }

  function resetTimer(){
    stopTimer(false);
    remaining = Number(state.settings.restSeconds || 75);
    updateTimerUI();
  }

  document.getElementById("timerStart").addEventListener("click", ()=>startTimer(state.settings.restSeconds || 75));
  document.getElementById("timerPause").addEventListener("click", ()=>pauseTimer());
  document.getElementById("timerReset").addEventListener("click", ()=>resetTimer());

  // -----------------------------
  // TOP ACTIONS
  // -----------------------------
  document.getElementById("goToday").addEventListener("click", ()=>{
    const today = new Date();
    currentMonday = getMonday(today);
    renderHome();
    // open today's day
    const dayIndex = (today.getDay()+6)%7;
    openSession(dayIndex);
  });

  document.getElementById("resetAll").addEventListener("click", ()=>{
    if(confirm("Reset du mois : s√©ries + semaines + mesures ?")){
      localStorage.removeItem(MKEY);
      location.reload();
    }
  });

  // -----------------------------
  // INIT
  // -----------------------------
  (function migrate(){
    state.settings = Object.assign(structuredClone(stateDefault.settings), state.settings || {});
    state.weeks = state.weeks || {};
    state.measures = state.measures || [];
  })();

  renderHome();
  updateTimerUI();
</script>
</body>
</html>